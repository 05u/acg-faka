#{include file="../Header.html"}

<!--begin::Content-->
<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
    <!--begin::Toolbar-->
    #{include file="../Toolbar.html"}
    <!--end::Toolbar-->
    <!--begin::Post-->
    <div class="post d-flex flex-column-fluid" id="kt_post">
        <!--begin::Container-->
        <div id="kt_content_container" class="container-fluid">
            <!--begin::Tables Widget 9-->
            <div class="card mb-5 mb-xl-8">
                <div class="card-body py-3">
                    <table id="pay-plugin" lay-filter="pay-plugin"></table>
                </div>
            </div>

            <!--end::Tables Widget 9-->
        </div>
        <!--end::Container-->
    </div>
    <!--end::Post-->
</div>
<!--end::Content-->

<script>

    $(function () {
        layui.use(['table', 'hex'], function () {
            let table = layui.table;
            var cao = layui.hex;

            var tableInstance = table.render({
                elem: '#pay-plugin'
                , skin: 'nob'
                , size: 'lg'
                , height: document.documentElement.clientHeight - 280
                , url: '/admin/api/pay/getPlugins'
                , page: false
                , method: "post"
                , response: {
                    statusCode: 200
                }
                , cols: [[
                    {
                        field: 'name', title: '插件名称', templet: function (item) {
                            return '<span class="badge badge-light-success">' + item.info.name + '</span>';
                        }
                    }
                    , {
                        field: 'website', title: '官方网站', templet: function (item) {
                            return '<span class="badge badge-light-primary">' + item.info.website + '</span>';
                        }
                    }
                    , {
                        field: 'description', title: '简介', templet: function (item) {
                            return '<span class="badge badge-light">' + item.info.description + '</span>';
                        }
                    }
                    , {
                        field: 'version', title: '版本号', templet: function (item) {
                            return '<span class="badge badge-light">' + item.info.version + '</span>';
                        }
                    }
                    , {
                        field: 'author', title: '作者', templet: function (item) {
                            return '<span class="badge badge-light">' + item.info.author + '</span>';
                        }
                    }
                    , {
                        field: 'options', title: '功能', templet: function (item) {
                            let list = [];
                            for (const key in item.info.options) {
                                list.push('<span class="badge badge-success me-1">' + item.info.options[key] + '</span>');
                            }
                            return list.join("");
                        }
                    }
                    , {
                        templet: function (item) {
                            return '<a data-id="' + item.id + '" class="badge badge-light text-success log" style="cursor: pointer;"><i class="far fa-clipboard text-success"></i> 日志</a> <a style="cursor: pointer;" data-id="' + item.id + '" class="badge badge-light text-success edit"><i class="fa fa-cog text-success"></i> 配置</a>';
                        },width : 160
                    }
                ]],
                done: res => {
                    cao.setIdMap(res.data);
                    $('.edit').click(function () {
                        let mapItem = cao.getMapItem(this);
                        modal(mapItem);
                    });

                    $('.log').click(function () {
                        let mapItem = cao.getMapItem(this);
                        $.post('/admin/api/pay/getPluginLog', {handle: mapItem.handle}, res => {
                            if (res.code != 200) {
                                layer.msg(res.msg);
                                return;
                            }
                            layer.open({
                                type: 1,
                                shade: 0.4,
                                shadeClose: true, //开启遮罩关闭
                                title: '<i class="fas fa-robot" style="color: #f16a8b;"></i> 日志', //不显示标题
                                btn: ["清空日志", "关闭"],
                                content: '<textarea class="log-textarea" style="width: 100%;height: 100%;border: none;color: grey;padding: 5px;">' + res.data.log + '</textarea>',
                                area: ["860px", "660px"],
                                maxmin: true,
                                yes: (index, layero) => {
                                    $.post('/admin/api/pay/ClearPluginLog', {handle: mapItem.handle}, res => {
                                        layer.msg("日志已清空");
                                    });
                                },
                                success: (layero, index) => {
                                    this.timer = setInterval(() => {
                                        $.post('/admin/api/pay/getPluginLog', {handle: mapItem.handle}, res => {
                                            if (res.data.log != $('.log-textarea').html()) {
                                                $('.log-textarea').html(res.data.log);
                                            }
                                        });
                                    }, 1500);
                                },
                                end: () => {
                                    clearInterval(this.timer);
                                }
                            });
                        });
                    });
                }
            });

            let modal = (values = {}) => {
                cao.popup('/admin/api/pay/setPluginConfig', values.submit, res => {
                    tableInstance.reload();
                }, values, "660px", false, "插件配置");
            }
        });
    });
</script>

#{include file="../Footer.html"}